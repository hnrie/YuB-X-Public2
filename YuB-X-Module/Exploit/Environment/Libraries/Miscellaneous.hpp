#pragma once

#include <Windows.h>
#include <lstate.h>
#include <lgc.h>

#include <Exploit/Utils.hpp>
#include <Exploit/Globals.hpp>

namespace miscellaneous
{
    int get_genv(lua_State* L)
    {
        if (shared_variables::exploit_thread == L)
        {
            lua_pushvalue(L, LUA_GLOBALSINDEX);
            return 1;
        }

        lua_rawcheckstack(L, 1);
        luaC_threadbarrier(L);
        luaC_threadbarrier(shared_variables::exploit_thread);
        lua_pushvalue(shared_variables::exploit_thread, LUA_GLOBALSINDEX);
        lua_xmove(shared_variables::exploit_thread, L, 1);

        return 1;
    }

    int identify_executor(lua_State* L)
    {
        lua_pushstring(L, "YuB-X-Public");
        lua_pushstring(L, "1.0.0");

        return 2;
    };

    int get_executor_name(lua_State* L)
    {
        lua_pushstring(L, "YuB-X-Public");

        return 1;
    };

    int get_objects(lua_State* L)
    {
        luaL_checktype(L, 1, LUA_TUSERDATA);
        luaL_checktype(L, 2, LUA_TSTRING);

        lua_getglobal(L, "game");
        lua_getfield(L, -1, "GetService");
        lua_pushvalue(L, -2);
        lua_pushstring(L, "InsertService");
        lua_call(L, 2, 1);
        lua_remove(L, -2);

        lua_getfield(L, -1, "LoadLocalAsset");

        lua_pushvalue(L, -2);
        lua_pushvalue(L, 2);
        lua_pcall(L, 2, 1, 0);

        if (lua_type(L, -1) == LUA_TSTRING)
            luaL_error(L, lua_tostring(L, -1));

        lua_createtable(L, 1, 0);
        lua_pushvalue(L, -2);
        lua_rawseti(L, -2, 1);

        lua_remove(L, -3);
        lua_remove(L, -2);

        return 1;
    }

    void register_lib(lua_State* L)
    {
        utils::add_function(L, "getgenv", miscellaneous::get_genv);
        utils::add_function(L, "identifyexecutor", miscellaneous::identify_executor);
        utils::add_function(L, "getexecutorname", miscellaneous::get_executor_name);
    }
}
