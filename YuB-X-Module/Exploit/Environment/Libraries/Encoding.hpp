#pragma once

#include <Windows.h>
#include <lstate.h>
#include <lualib.h>
#include <string>
#include <vector>

#include <Exploit/Utils.hpp>

namespace encoding
{
    static const char base64_chars[] =
        "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";

    static inline bool is_base64_char(char c)
    {
        return (isalnum(static_cast<unsigned char>(c)) || c == '+' || c == '/');
    }

    std::string base64_encode(const std::string& input)
    {
        std::string encoded;
        int i = 0;
        unsigned char char_array3[3];
        unsigned char char_array4[4];
        size_t in_len = input.size();
        size_t pos = 0;

        while (in_len--)
        {
            char_array3[i++] = input[pos++];
            if (i == 3)
            {
                char_array4[0] = (char_array3[0] & 0xfc) >> 2;
                char_array4[1] = ((char_array3[0] & 0x03) << 4) + ((char_array3[1] & 0xf0) >> 4);
                char_array4[2] = ((char_array3[1] & 0x0f) << 2) + ((char_array3[2] & 0xc0) >> 6);
                char_array4[3] = char_array3[2] & 0x3f;

                for (i = 0; i < 4; i++)
                    encoded += base64_chars[char_array4[i]];
                i = 0;
            }
        }

        if (i)
        {
            for (int j = i; j < 3; j++)
                char_array3[j] = '\0';

            char_array4[0] = (char_array3[0] & 0xfc) >> 2;
            char_array4[1] = ((char_array3[0] & 0x03) << 4) + ((char_array3[1] & 0xf0) >> 4);
            char_array4[2] = ((char_array3[1] & 0x0f) << 2) + ((char_array3[2] & 0xc0) >> 6);

            for (int j = 0; j < i + 1; j++)
                encoded += base64_chars[char_array4[j]];

            while (i++ < 3)
                encoded += '=';
        }

        return encoded;
    }

    std::string base64_decode(const std::string& input)
    {
        size_t in_len = input.size();
        int i = 0;
        int j = 0;
        int in_ = 0;
        unsigned char char_array4[4];
        unsigned char char_array3[3];
        std::string decoded;

        while (in_len-- && input[in_] != '=' && is_base64_char(input[in_]))
        {
            char_array4[i++] = input[in_];
            in_++;
            if (i == 4)
            {
                for (i = 0; i < 4; i++)
                {
                    const char* p = strchr(base64_chars, char_array4[i]);
                    char_array4[i] = static_cast<unsigned char>(p ? (p - base64_chars) : 0);
                }

                char_array3[0] = (char_array4[0] << 2) + ((char_array4[1] & 0x30) >> 4);
                char_array3[1] = ((char_array4[1] & 0x0f) << 4) + ((char_array4[2] & 0x3c) >> 2);
                char_array3[2] = ((char_array4[2] & 0x03) << 6) + char_array4[3];

                for (i = 0; i < 3; i++)
                    decoded += char_array3[i];
                i = 0;
            }
        }

        if (i)
        {
            for (j = i; j < 4; j++)
                char_array4[j] = 0;

            for (j = 0; j < 4; j++)
            {
                const char* p = strchr(base64_chars, char_array4[j]);
                char_array4[j] = static_cast<unsigned char>(p ? (p - base64_chars) : 0);
            }

            char_array3[0] = (char_array4[0] << 2) + ((char_array4[1] & 0x30) >> 4);
            char_array3[1] = ((char_array4[1] & 0x0f) << 4) + ((char_array4[2] & 0x3c) >> 2);

            for (j = 0; j < i - 1; j++)
                decoded += char_array3[j];
        }

        return decoded;
    }

    std::string url_encode(const std::string& input)
    {
        std::string encoded;
        char hex[] = "0123456789ABCDEF";

        for (size_t i = 0; i < input.length(); i++)
        {
            char c = input[i];
            if (isalnum(static_cast<unsigned char>(c)) ||
                c == '-' || c == '_' || c == '.' || c == '~')
            {
                encoded += c;
            }
            else
            {
                encoded += '%';
                encoded += hex[(c >> 4) & 0x0f];
                encoded += hex[c & 0x0f];
            }
        }

        return encoded;
    }

    std::string url_decode(const std::string& input)
    {
        std::string decoded;
        size_t length = input.length();

        for (size_t i = 0; i < length; i++)
        {
            if (input[i] == '%' && i + 2 < length)
            {
                int value = 0;
                for (int j = 1; j <= 2; j++)
                {
                    char c = input[i + j];
                    if (c >= '0' && c <= '9')
                        value = value * 16 + (c - '0');
                    else if (c >= 'A' && c <= 'F')
                        value = value * 16 + (c - 'A' + 10);
                    else if (c >= 'a' && c <= 'f')
                        value = value * 16 + (c - 'a' + 10);
                }
                decoded += static_cast<char>(value);
                i += 2;
            }
            else if (input[i] == '+')
            {
                decoded += ' ';
            }
            else
            {
                decoded += input[i];
            }
        }

        return decoded;
    }

    int base64_encode_func(lua_State* L)
    {
        size_t len = 0;
        const char* data = luaL_checklstring(L, 1, &len);
        std::string encoded = base64_encode(std::string(data, len));
        lua_pushstring(L, encoded.c_str());
        return 1;
    }

    int base64_decode_func(lua_State* L)
    {
        const char* data = luaL_checkstring(L, 1);
        std::string decoded = base64_decode(data);
        lua_pushlstring(L, decoded.data(), decoded.size());
        return 1;
    }

    int url_encode_func(lua_State* L)
    {
        const char* data = luaL_checkstring(L, 1);
        std::string encoded = url_encode(data);
        lua_pushstring(L, encoded.c_str());
        return 1;
    }

    int url_decode_func(lua_State* L)
    {
        const char* data = luaL_checkstring(L, 1);
        std::string decoded = url_decode(data);
        lua_pushstring(L, decoded.c_str());
        return 1;
    }

    int base64_encode_table(lua_State* L)
    {
        size_t len = 0;
        const char* data = luaL_checklstring(L, 1, &len);
        std::string encoded = base64_encode(std::string(data, len));
        lua_pushstring(L, encoded.c_str());
        return 1;
    }

    int base64_decode_table(lua_State* L)
    {
        const char* data = luaL_checkstring(L, 1);
        std::string decoded = base64_decode(data);
        lua_pushlstring(L, decoded.data(), decoded.size());
        return 1;
    }

    void register_lib(lua_State* L)
    {
        utils::add_function(L, "base64_encode", encoding::base64_encode_func);
        utils::add_function(L, "base64_decode", encoding::base64_decode_func);
        utils::add_function(L, "urlEncode", encoding::url_encode_func);
        utils::add_function(L, "urlDecode", encoding::url_decode_func);

        lua_newtable(L);
        utils::add_table_function(L, "encode", encoding::base64_encode_table);
        utils::add_table_function(L, "decode", encoding::base64_decode_table);
        lua_setglobal(L, "base64");
    }
}
