#pragma once

#include <Windows.h>
#include <lstate.h>
#include <lualib.h>
#include <string>
#include <vector>

#include <Exploit/Utils.hpp>

namespace Encoding
{
    static const char Base64Chars[] =
        "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";

    static inline bool IsBase64Char(char c)
    {
        return (isalnum(static_cast<unsigned char>(c)) || c == '+' || c == '/');
    }

    std::string Base64Encode(const std::string& input)
    {
        std::string encoded;
        int i = 0;
        unsigned char charArray3[3];
        unsigned char charArray4[4];
        size_t in_len = input.size();
        size_t pos = 0;

        while (in_len--)
        {
            charArray3[i++] = input[pos++];
            if (i == 3)
            {
                charArray4[0] = (charArray3[0] & 0xfc) >> 2;
                charArray4[1] = ((charArray3[0] & 0x03) << 4) + ((charArray3[1] & 0xf0) >> 4);
                charArray4[2] = ((charArray3[1] & 0x0f) << 2) + ((charArray3[2] & 0xc0) >> 6);
                charArray4[3] = charArray3[2] & 0x3f;

                for (i = 0; i < 4; i++)
                    encoded += Base64Chars[charArray4[i]];
                i = 0;
            }
        }

        if (i)
        {
            for (int j = i; j < 3; j++)
                charArray3[j] = '\0';

            charArray4[0] = (charArray3[0] & 0xfc) >> 2;
            charArray4[1] = ((charArray3[0] & 0x03) << 4) + ((charArray3[1] & 0xf0) >> 4);
            charArray4[2] = ((charArray3[1] & 0x0f) << 2) + ((charArray3[2] & 0xc0) >> 6);

            for (int j = 0; j < i + 1; j++)
                encoded += Base64Chars[charArray4[j]];

            while (i++ < 3)
                encoded += '=';
        }

        return encoded;
    }

    std::string Base64Decode(const std::string& input)
    {
        size_t in_len = input.size();
        int i = 0;
        int j = 0;
        int in_ = 0;
        unsigned char charArray4[4];
        unsigned char charArray3[3];
        std::string decoded;

        while (in_len-- && input[in_] != '=' && IsBase64Char(input[in_]))
        {
            charArray4[i++] = input[in_];
            in_++;
            if (i == 4)
            {
                for (i = 0; i < 4; i++)
                {
                    const char* p = strchr(Base64Chars, charArray4[i]);
                    charArray4[i] = static_cast<unsigned char>(p ? (p - Base64Chars) : 0);
                }

                charArray3[0] = (charArray4[0] << 2) + ((charArray4[1] & 0x30) >> 4);
                charArray3[1] = ((charArray4[1] & 0x0f) << 4) + ((charArray4[2] & 0x3c) >> 2);
                charArray3[2] = ((charArray4[2] & 0x03) << 6) + charArray4[3];

                for (i = 0; i < 3; i++)
                    decoded += charArray3[i];
                i = 0;
            }
        }

        if (i)
        {
            for (j = i; j < 4; j++)
                charArray4[j] = 0;

            for (j = 0; j < 4; j++)
            {
                const char* p = strchr(Base64Chars, charArray4[j]);
                charArray4[j] = static_cast<unsigned char>(p ? (p - Base64Chars) : 0);
            }

            charArray3[0] = (charArray4[0] << 2) + ((charArray4[1] & 0x30) >> 4);
            charArray3[1] = ((charArray4[1] & 0x0f) << 4) + ((charArray4[2] & 0x3c) >> 2);

            for (j = 0; j < i - 1; j++)
                decoded += charArray3[j];
        }

        return decoded;
    }

    std::string UrlEncode(const std::string& input)
    {
        std::string encoded;
        char hex[] = "0123456789ABCDEF";

        for (size_t i = 0; i < input.length(); i++)
        {
            char c = input[i];
            if (isalnum(static_cast<unsigned char>(c)) ||
                c == '-' || c == '_' || c == '.' || c == '~')
            {
                encoded += c;
            }
            else
            {
                encoded += '%';
                encoded += hex[(c >> 4) & 0x0F];
                encoded += hex[c & 0x0F];
            }
        }

        return encoded;
    }

    std::string UrlDecode(const std::string& input)
    {
        std::string decoded;
        size_t length = input.length();

        for (size_t i = 0; i < length; i++)
        {
            if (input[i] == '%' && i + 2 < length)
            {
                int value = 0;
                for (int j = 1; j <= 2; j++)
                {
                    char c = input[i + j];
                    if (c >= '0' && c <= '9')
                        value = value * 16 + (c - '0');
                    else if (c >= 'A' && c <= 'F')
                        value = value * 16 + (c - 'A' + 10);
                    else if (c >= 'a' && c <= 'f')
                        value = value * 16 + (c - 'a' + 10);
                }
                decoded += static_cast<char>(value);
                i += 2;
            }
            else if (input[i] == '+')
            {
                decoded += ' ';
            }
            else
            {
                decoded += input[i];
            }
        }

        return decoded;
    }

    int base64_encode(lua_State* L)
    {
        size_t len = 0;
        const char* data = luaL_checklstring(L, 1, &len);
        std::string encoded = Base64Encode(std::string(data, len));
        lua_pushstring(L, encoded.c_str());
        return 1;
    }

    int base64_decode(lua_State* L)
    {
        const char* data = luaL_checkstring(L, 1);
        std::string decoded = Base64Decode(data);
        lua_pushlstring(L, decoded.data(), decoded.size());
        return 1;
    }

    int urlEncode(lua_State* L)
    {
        const char* data = luaL_checkstring(L, 1);
        std::string encoded = UrlEncode(data);
        lua_pushstring(L, encoded.c_str());
        return 1;
    }

    int urlDecode(lua_State* L)
    {
        const char* data = luaL_checkstring(L, 1);
        std::string decoded = UrlDecode(data);
        lua_pushstring(L, decoded.c_str());
        return 1;
    }

    int base64__encode(lua_State* L)
    {
        size_t len = 0;
        const char* data = luaL_checklstring(L, 1, &len);
        std::string encoded = Base64Encode(std::string(data, len));
        lua_pushstring(L, encoded.c_str());
        return 1;
    }

    int base64__decode(lua_State* L)
    {
        const char* data = luaL_checkstring(L, 1);
        std::string decoded = Base64Decode(data);
        lua_pushlstring(L, decoded.data(), decoded.size());
        return 1;
    }

    void RegisterLibrary(lua_State* L)
    {
        Utils::AddFunction(L, "base64_encode", Encoding::base64_encode);
        Utils::AddFunction(L, "base64_decode", Encoding::base64_decode);
        Utils::AddFunction(L, "urlEncode", Encoding::urlEncode);
        Utils::AddFunction(L, "urlDecode", Encoding::urlDecode);

        lua_newtable(L);
        Utils::AddTableFunction(L, "encode", Encoding::base64__encode);
        Utils::AddTableFunction(L, "decode", Encoding::base64__decode);
        lua_setglobal(L, "base64");
    }
}
